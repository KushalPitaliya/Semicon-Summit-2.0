/**
 * Database Seeder for Semiconductor Summit 2.0
 * 
 * This script seeds the database with initial data for development and testing.
 * Run with: node seeders/seed.js
 * 
 * Options:
 *   --fresh    Drop all collections before seeding
 *   --users    Seed only users
 *   --gallery  Seed only gallery
 *   --all      Seed everything (default)
 */

require('dotenv').config();
const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');

// Import models
const User = require('../models/User');
const Gallery = require('../models/Gallery');
const Announcement = require('../models/Announcement');

// Configuration
const MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/semiconductor_summit';

// Parse command line arguments
const args = process.argv.slice(2);
const isFresh = args.includes('--fresh');

// Check if any specific seed target is specified
const hasSpecificTarget = args.includes('--users') || args.includes('--gallery') || args.includes('--announcements');

// If no specific target, seed everything. If --fresh only, also seed everything.
const seedUsers = args.includes('--users') || args.includes('--all') || !hasSpecificTarget;
const seedGallery = args.includes('--gallery') || args.includes('--all') || !hasSpecificTarget;
const seedAnnouncements = args.includes('--announcements') || args.includes('--all') || !hasSpecificTarget;

// Colors for console output
const colors = {
    reset: '\x1b[0m',
    bright: '\x1b[1m',
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    red: '\x1b[31m',
    cyan: '\x1b[36m',
    magenta: '\x1b[35m'
};

const log = {
    info: (msg) => console.log(`${colors.cyan}â„¹${colors.reset} ${msg}`),
    success: (msg) => console.log(`${colors.green}âœ“${colors.reset} ${msg}`),
    warn: (msg) => console.log(`${colors.yellow}âš ${colors.reset} ${msg}`),
    error: (msg) => console.log(`${colors.red}âœ—${colors.reset} ${msg}`),
    title: (msg) => console.log(`\n${colors.bright}${colors.magenta}${msg}${colors.reset}\n`)
};

// ============================================
// SEED DATA
// ============================================

const usersData = [
    {
        name: 'Dr. Rajesh Kumar',
        email: 'faculty@demo.com',
        password: 'demo123',
        role: 'faculty',
        phone: '9876543210',
        college: 'Indian Institute of Technology',
        department: 'Electronics Engineering',
        verificationStatus: 'approved',
        paymentStatus: 'completed'
    },
    {
        name: 'Prof. Anita Sharma',
        email: 'faculty2@demo.com',
        password: 'demo123',
        role: 'faculty',
        phone: '9876543211',
        college: 'National Institute of Technology',
        department: 'VLSI Design',
        verificationStatus: 'approved',
        paymentStatus: 'completed'
    },
    {
        name: 'Priya Coordinator',
        email: 'coordinator@demo.com',
        password: 'demo123',
        role: 'coordinator',
        phone: '9876543212',
        college: 'VIT University',
        department: 'Electronics and Communication',
        verificationStatus: 'approved',
        paymentStatus: 'completed'
    },
    {
        name: 'Rahul Coordinator',
        email: 'coordinator2@demo.com',
        password: 'demo123',
        role: 'coordinator',
        phone: '9876543213',
        college: 'SRM University',
        department: 'Electronics',
        verificationStatus: 'approved',
        paymentStatus: 'completed'
    },
    {
        name: 'Amit Participant',
        email: 'participant@demo.com',
        password: 'demo123',
        role: 'participant',
        phone: '9876543214',
        college: 'Anna University',
        department: 'ECE',
        selectedEvents: ['VLSI Design Workshop', 'Chip Architecture Talk'],
        verificationStatus: 'approved',
        paymentStatus: 'completed',
        paymentAmount: 400,
        paymentRef: 'DEMO123456789'
    },
    {
        name: 'Sneha Patel',
        email: 'participant2@demo.com',
        password: 'demo123',
        role: 'participant',
        phone: '9876543215',
        college: 'Gujarat Technological University',
        department: 'Electronics',
        selectedEvents: ['Embedded Systems Hackathon', 'Industry Panel Discussion'],
        verificationStatus: 'approved',
        paymentStatus: 'completed',
        paymentAmount: 200,
        paymentRef: 'DEMO987654321'
    },
    {
        name: 'Vikram Singh',
        email: 'pending@demo.com',
        password: 'demo123',
        role: 'participant',
        phone: '9876543216',
        college: 'Delhi Technological University',
        department: 'Computer Engineering',
        selectedEvents: ['VLSI Design Workshop'],
        verificationStatus: 'pending',
        paymentStatus: 'pending',
        paymentAmount: 400,
        paymentRef: 'PENDING123456'
    },
    {
        name: 'Meera Krishnan',
        email: 'pending2@demo.com',
        password: 'demo123',
        role: 'participant',
        phone: '9876543217',
        college: 'IIT Madras',
        department: 'Electrical Engineering',
        selectedEvents: ['Chip Architecture Talk', 'Industry Panel Discussion'],
        verificationStatus: 'pending',
        paymentStatus: 'pending',
        paymentAmount: 0,
        paymentRef: 'PENDING654321'
    }
];

const galleryData = [
    {
        title: 'Opening Ceremony',
        description: 'The grand opening ceremony of Semiconductor Summit 1.0 with distinguished guests.',
        category: 'event',
        publicId: 'seed/opening_ceremony',
        url: 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=800',
        thumbnailUrl: 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=400',
        tags: ['opening', 'ceremony', 'summit'],
        isFeatured: true
    },
    {
        title: 'VLSI Workshop Session',
        description: 'Hands-on workshop on advanced VLSI design techniques.',
        category: 'workshop',
        publicId: 'seed/vlsi_workshop',
        url: 'https://images.unsplash.com/photo-1517694712202-14dd9538aa97?w=800',
        thumbnailUrl: 'https://images.unsplash.com/photo-1517694712202-14dd9538aa97?w=400',
        tags: ['workshop', 'vlsi', 'hands-on'],
        isFeatured: true
    },
    {
        title: 'Industry Expert Panel',
        description: 'Industry leaders discussing the future of semiconductor technology.',
        category: 'speaker',
        publicId: 'seed/expert_panel',
        url: 'https://images.unsplash.com/photo-1475721027785-f74eccf877e2?w=800',
        thumbnailUrl: 'https://images.unsplash.com/photo-1475721027785-f74eccf877e2?w=400',
        tags: ['panel', 'discussion', 'experts'],
        isFeatured: true
    },
    {
        title: 'Networking Session',
        description: 'Participants networking during the coffee break.',
        category: 'networking',
        publicId: 'seed/networking',
        url: 'https://images.unsplash.com/photo-1511578314322-379afb476865?w=800',
        thumbnailUrl: 'https://images.unsplash.com/photo-1511578314322-379afb476865?w=400',
        tags: ['networking', 'coffee', 'break'],
        isFeatured: false
    },
    {
        title: 'Hackathon Winners',
        description: 'The winning team of the Embedded Systems Hackathon.',
        category: 'event',
        publicId: 'seed/hackathon_winners',
        url: 'https://images.unsplash.com/photo-1504384308090-c894fdcc538d?w=800',
        thumbnailUrl: 'https://images.unsplash.com/photo-1504384308090-c894fdcc538d?w=400',
        tags: ['hackathon', 'winners', 'team'],
        isFeatured: true
    },
    {
        title: 'Conference Venue',
        description: 'The beautiful venue hosting Semiconductor Summit.',
        category: 'venue',
        publicId: 'seed/venue',
        url: 'https://images.unsplash.com/photo-1431540015161-0bf868a2d407?w=800',
        thumbnailUrl: 'https://images.unsplash.com/photo-1431540015161-0bf868a2d407?w=400',
        tags: ['venue', 'conference', 'hall'],
        isFeatured: false
    }
];

const announcementsData = [
    {
        title: 'Registration Now Open!',
        content: 'We are excited to announce that registration for Semiconductor Summit 2.0 is now open. Early bird discount available until March 1st!',
        targetAudience: 'all',
        isActive: true,
        priority: 'high'
    },
    {
        title: 'Workshop Schedule Released',
        content: 'The detailed workshop schedule has been released. Check the events section for timings and topics.',
        targetAudience: 'all',
        isActive: true,
        priority: 'normal'
    },
    {
        title: 'New Industry Speakers Confirmed',
        content: 'We are thrilled to announce that leading experts from Intel, AMD, and NVIDIA will be joining us as speakers!',
        targetAudience: 'all',
        isActive: true,
        priority: 'high'
    }
];

// ============================================
// SEEDER FUNCTIONS
// ============================================

async function connectDB() {
    log.info('Connecting to MongoDB...');
    try {
        await mongoose.connect(MONGODB_URI);
        log.success(`Connected to MongoDB: ${MONGODB_URI.replace(/\/\/.*:.*@/, '//<credentials>@')}`);
    } catch (error) {
        log.error(`Failed to connect: ${error.message}`);
        process.exit(1);
    }
}

async function clearCollections() {
    if (isFresh) {
        log.warn('Dropping all collections (--fresh mode)...');

        const collections = await mongoose.connection.db.listCollections().toArray();
        for (const collection of collections) {
            await mongoose.connection.db.dropCollection(collection.name);
            log.info(`  Dropped: ${collection.name}`);
        }
        log.success('All collections cleared');
    }
}

async function seedUsersCollection() {
    log.title('ğŸ“¦ Seeding Users');

    let created = 0;
    let skipped = 0;

    for (const userData of usersData) {
        try {
            // Check if user already exists
            const existingUser = await User.findOne({ email: userData.email });

            if (existingUser) {
                log.warn(`  Skipped (exists): ${userData.email}`);
                skipped++;
                continue;
            }

            // Create user - password will be hashed by the User model's pre-save hook
            const user = new User(userData);

            await user.save();
            log.success(`  Created: ${userData.name} (${userData.email}) - ${userData.role}`);
            created++;

        } catch (error) {
            log.error(`  Failed to create ${userData.email}: ${error.message}`);
        }
    }

    log.info(`Users: ${created} created, ${skipped} skipped`);
}

async function seedGalleryCollection() {
    log.title('ğŸ–¼ï¸  Seeding Gallery');

    let created = 0;
    let skipped = 0;

    // Get a faculty user to set as uploader
    const faculty = await User.findOne({ role: 'faculty' });

    for (const imageData of galleryData) {
        try {
            // Check if image with same title exists
            const existingImage = await Gallery.findOne({ title: imageData.title });

            if (existingImage) {
                log.warn(`  Skipped (exists): ${imageData.title}`);
                skipped++;
                continue;
            }

            // Create gallery entry
            const image = new Gallery({
                ...imageData,
                uploadedBy: faculty?._id
            });

            await image.save();
            log.success(`  Created: ${imageData.title} (${imageData.category})`);
            created++;

        } catch (error) {
            log.error(`  Failed to create ${imageData.title}: ${error.message}`);
        }
    }

    log.info(`Gallery: ${created} created, ${skipped} skipped`);
}

async function seedAnnouncementsCollection() {
    log.title('ğŸ“¢ Seeding Announcements');

    let created = 0;
    let skipped = 0;

    // Get a faculty user to set as author
    const faculty = await User.findOne({ role: 'faculty' });

    for (const announcementData of announcementsData) {
        try {
            // Check if announcement with same title exists
            const existingAnnouncement = await Announcement.findOne({ title: announcementData.title });

            if (existingAnnouncement) {
                log.warn(`  Skipped (exists): ${announcementData.title}`);
                skipped++;
                continue;
            }

            // Create announcement
            const announcement = new Announcement({
                ...announcementData,
                createdBy: faculty?._id
            });

            await announcement.save();
            log.success(`  Created: ${announcementData.title}`);
            created++;

        } catch (error) {
            log.error(`  Failed to create ${announcementData.title}: ${error.message}`);
        }
    }

    log.info(`Announcements: ${created} created, ${skipped} skipped`);
}

async function printSummary() {
    log.title('ğŸ“Š Database Summary');

    const userCount = await User.countDocuments();
    const galleryCount = await Gallery.countDocuments();
    const announcementCount = await Announcement.countDocuments();

    console.log(`  Users:         ${userCount}`);
    console.log(`  Gallery:       ${galleryCount}`);
    console.log(`  Announcements: ${announcementCount}`);

    log.title('ğŸ” Demo Credentials');
    console.log('  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
    console.log('  â”‚  Role         â”‚  Email                â”‚  Password â”‚');
    console.log('  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
    console.log('  â”‚  Faculty      â”‚  faculty@demo.com     â”‚  demo123  â”‚');
    console.log('  â”‚  Coordinator  â”‚  coordinator@demo.com â”‚  demo123  â”‚');
    console.log('  â”‚  Participant  â”‚  participant@demo.com â”‚  demo123  â”‚');
    console.log('  â”‚  Pending      â”‚  pending@demo.com     â”‚  demo123  â”‚');
    console.log('  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
}

// ============================================
// MAIN EXECUTION
// ============================================

async function main() {
    console.log('\n');
    log.title('ğŸŒ± Semiconductor Summit 2.0 - Database Seeder');
    console.log('â”€'.repeat(50));

    try {
        await connectDB();
        await clearCollections();

        if (seedUsers) await seedUsersCollection();
        if (seedGallery) await seedGalleryCollection();
        if (seedAnnouncements) await seedAnnouncementsCollection();

        await printSummary();

        log.success('\nâœ¨ Seeding completed successfully!\n');

    } catch (error) {
        log.error(`Seeding failed: ${error.message}`);
        console.error(error);
    } finally {
        await mongoose.connection.close();
        log.info('Database connection closed');
        process.exit(0);
    }
}

main();
